/*
 * Copyright 2018 @adam-26.
 * Copyrights licensed under the MIT License.
 * See the accompanying LICENSE file for terms.
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var react=require("react"),server=require("react-dom/server"),invariant=_interopDefault(require("invariant")),stream=require("stream"),DEFAULT_APP_ELEMENT_ID="app";function defaultTo(e,t){return"function"==typeof e?e():t}function getAppContainerProps(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.appContainerTagName,n=t.appContainerId,a=null===e?null:e.type,o=n||defaultTo(a&&a.getAppContainerId,DEFAULT_APP_ELEMENT_ID);return{tagName:r||defaultTo(a&&a.getAppContainerTagName,"div"),id:o,querySelector:"#"+o}}var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},objectWithoutProperties=function(e,t){var r={};for(var n in e)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},HTML5_DOCTYPE="<!DOCTYPE html>",HTML_TAG="html",HEAD_TAG="head",BODY_TAG="body",APP_TAG="app";function message(e){return"[react-dom-html] "+e}function resolveOptionalElement(e){return react.isValidElement(e)||"function"!=typeof e?e:e()}function renderStaticOpeningTagFromElement(e){var t=server.renderToStaticMarkup(e);return t.substring(0,t.length-(e.type.length+3))}function createAppContainerElement(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.id,a=r.children,o=objectWithoutProperties(r,["id","children"]),i=getAppContainerProps(e,{appContainerTagName:t,appContainerId:n}),l=i.tagName,p=i.id;return react.createElement(l,_extends({id:p},o),a)}var VALID_ROOT_CHILD_TAGS=[HTML_TAG],VALID_HTML_CHILD_TAGS=[HEAD_TAG,BODY_TAG];function resolveHtml(e,t,r){var n=e.props,a=n.children,o=objectWithoutProperties(n,["children"]);return t.htmlElement=react.createElement(HTML_TAG,o),a&&react.Children.count(a)>0&&react.Children.forEach(a,function(e){t=resolveHtmlElement(e,t,VALID_HTML_CHILD_TAGS,r)}),t}function resolveBody(e,t,r){var n=e.props,a=n.children,o=objectWithoutProperties(n,["children"]);t.bodyElement=react.createElement(BODY_TAG,o);var i=0,l=!1;return t.beforeAppContainerElement=[],t.afterAppContainerElement=[],react.Children.forEach(a,function(e){e.type===APP_TAG?(resolveApp(e,t,r),l=!0):l?t.afterAppContainerElement.push(react.cloneElement(e,{key:i++})):t.beforeAppContainerElement.push(react.cloneElement(e,{key:i++}))}),t}function resolveApp(e,t,r){var n=e.props,a=n.children,o=objectWithoutProperties(n,["children"]),i=r.allowAppContainerChildren;if(!i&&0!==react.Children.count(a))throw new Error(message("<app> does not support the use of children."));return t.appContainerProps=o,i&&a&&(t.appContainerProps.children=a),t}function resolveHead(e,t){return t.headElement=e,t}function resolveHtmlElement(e,t,r,n){var a=react.Children.only(e),o=a.type;if(-1!==r.indexOf(o)){if(o===HTML_TAG)return resolveHtml(a,t,n);if(o===HEAD_TAG)return resolveHead(a,t);if(o===BODY_TAG)return resolveBody(a,t,n)}throw new Error(message('Invalid html markup, tag "'+o+'" is not supported in its current position.'))}function assignOptions(e,t){var r=Object.keys(t).reduce(function(e,r){var n=t[r];return void 0!==n&&t.hasOwnProperty(r)&&(e[r]=n),e},{});return Object.assign({},e,r)}var defaultElements={htmlElement:react.createElement(HTML_TAG),headElement:react.createElement(HEAD_TAG),bodyElement:react.createElement(BODY_TAG)};function mapOptionsToState(e,t){var r=t.html,n=t.appContainerTagName,a=t.htmlElements,o=t.allowAppContainerChildren,i=objectWithoutProperties(t,["html","appContainerTagName","htmlElements","allowAppContainerChildren"]);if(r){var l=resolveOptionalElement(r);invariant(react.isValidElement(l),"`html` is required to be a react element.");var p=resolveHtmlElement(l,{},VALID_ROOT_CHILD_TAGS,{allowAppContainerChildren:"boolean"==typeof o&&o}),u=p.appContainerProps,s=objectWithoutProperties(p,["appContainerProps"]);return s.appContainerElement=createAppContainerElement(e,n,u),void 0===s.headElement&&(s.headElement=react.createElement(HEAD_TAG)),assignOptions(defaultElements,_extends({},i,s))}if(a){var m="function"==typeof a?a():a,c=m.htmlElement,d=m.bodyElement,h=m.headElement,f=m.appContainerElement,_=m.beforeAppContainerElement,E=m.afterAppContainerElement;return assignOptions(defaultElements,_extends({},i,{htmlElement:c,bodyElement:d,headElement:h,beforeAppContainerElement:_,afterAppContainerElement:E,appContainerElement:f||createAppContainerElement(e,n)}))}return Object.assign({appContainerElement:createAppContainerElement(e,n)},defaultElements,i)}function renderHtmlToString(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return renderString("renderHtmlToString",server.renderToString,!1,e,t)}function renderHtmlToStaticMarkup(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return renderString("renderHtmlToStaticMarkup",server.renderToStaticMarkup,!0,e,t)}function renderString(e,t,r,n,a){var o=t(n),i=mapOptionsToState(n,a),l=i.htmlElement,p=i.bodyElement,u=i.headElement,s=i.appContainerElement,m=i.beforeAppContainerElement,c=i.afterAppContainerElement,d=renderStaticOpeningTagFromElement(l),h=renderStaticOpeningTagFromElement(p),f=renderStaticOpeningTagFromElement(s),_="string"==typeof u?u:r?server.renderToStaticMarkup(u):server.renderToString(u),E=m?server.renderToStaticMarkup(m):"",v=c?server.renderToStaticMarkup(c):"";return""+d+_+h+E+f+o+"</"+s.type+">"+v+"</body></html>"}var HtmlReadable=function(e){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};classCallCheck(this,t);var a=mapOptionsToState(e,n),o=a.htmlElement,i=a.bodyElement,l=a.headElement,p=a.appContainerElement,u=a.beforeAppContainerElement,s=a.afterAppContainerElement,m=objectWithoutProperties(a,["htmlElement","bodyElement","headElement","appContainerElement","beforeAppContainerElement","afterAppContainerElement"]),c=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,m));return c._isStaticMarkup=r,c._activeStream=null,c._rootElement=e,c._htmlElement=o,c._headElement=l,c._bodyElement=i,c._beforeAppContainerElement=u,c._afterAppContainerElement=s,c._appContainerElement=p,c._readers=c._getReaders(),c}return inherits(t,e),createClass(t,[{key:"_getReaders",value:function(){var e=this,t=[function(t){return e._readHtmlOpenTags(t)},function(t){return e._readHead(t)},function(t){return e._readBodyOpenTag(t)}];return this._beforeAppContainerElement&&t.push(function(t){return e._readStaticNodeStream(e._beforeAppContainerElement,t)}),Array.prototype.push.apply(t,[function(t){return e._readAppOpenTag(t)},function(t){return e._readHtmlApp(t)},function(t){return e._readAppCloseTag(t)}]),this._afterAppContainerElement&&t.push(function(t){return e._readStaticNodeStream(e._afterAppContainerElement,t)}),t.push(function(t){return e._readHtmlCloseTags(t)}),t}},{key:"_read",value:function(){var e=this;this._readNext(this._readers,function(){e._signalComplete()})}},{key:"_readNext",value:function(e,t){var r=this;return 0===e.length?t():this._activeStream?this._activeStream.resume():void e.shift()(function(n){n&&r._readNext(e,t)})}},{key:"_readHtmlOpenTags",value:function(e){this._pushMarkup(renderStaticOpeningTagFromElement(this._htmlElement),e)}},{key:"_readHead",value:function(e){return"string"==typeof this._headElement?this._pushMarkup(this._headElement,e):this._isStaticMarkup?this._readStaticNodeStream(this._headElement,e):void this._readNodeStream(this._headElement,e)}},{key:"_readBodyOpenTag",value:function(e){this._pushMarkup(renderStaticOpeningTagFromElement(this._bodyElement),e)}},{key:"_readAppOpenTag",value:function(e){this._pushMarkup(renderStaticOpeningTagFromElement(this._appContainerElement),e)}},{key:"_readAppCloseTag",value:function(e){this._pushMarkup("</"+this._appContainerElement.type+">",e)}},{key:"_readHtmlApp",value:function(e){if(this._isStaticMarkup)return this._readStaticNodeStream(this._rootElement,e);this._readNodeStream(this._rootElement,e)}},{key:"_readHtmlCloseTags",value:function(e){this._pushMarkup("</body></html>",e)}},{key:"_signalComplete",value:function(){this.push(null)}},{key:"_pushChunk",value:function(e,t){return this.push(e,t)}},{key:"_pushMarkup",value:function(e,t){if(!this._pushChunk(e,"utf8"))return t(!1);t(!0)}},{key:"_emitError",value:function(e){this.emit("error",e)}},{key:"_readNodeStream",value:function(e,t){var r=this._activeStream=server.renderToNodeStream(e);this._readStream(r,t)}},{key:"_readStaticNodeStream",value:function(e,t){var r=this._activeStream=server.renderToStaticNodeStream(e);this._readStream(r,t)}},{key:"_readStream",value:function(e,t){var r=this;e.on("error",function(e){r._emitError(e)}),e.on("end",function(){r._activeStream=null,t(!0)}),e.on("data",function(e){if(!r._pushChunk(e))return t(!1);t(!0)})}}]),t}(stream.Readable);function renderHtmlToNodeStream(){return renderToStream("renderHtmlToStaticNodeStream",!1,arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}function renderHtmlToStaticNodeStream(){return renderToStream("renderHtmlToStaticNodeStream",!0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}function renderToStream(e,t,r,n){return new HtmlReadable(r,t,n)}exports.HTML5_DOCTYPE=HTML5_DOCTYPE,exports.renderHtmlToString=renderHtmlToString,exports.renderHtmlToStaticMarkup=renderHtmlToStaticMarkup,exports.renderHtmlToNodeStream=renderHtmlToNodeStream,exports.renderHtmlToStaticNodeStream=renderHtmlToStaticNodeStream;
